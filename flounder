start-symbol: File
options: debug9

include: {{ #include "ast.h"
	    #include <vector>
	    #include <stdlib.h>
	    #include <string> }}
code: {{
      void cast_m(std::vector<Message* > * v, Value & val)
{
  for(Value::iterator it = val.getValues().begin(); it != val.getValues().end(); it++)
    {
      const Value & v2 = *it;
      Message* ms = (Message*) v2.getValue();
      v->push_back(ms);		     
    }
}
void cast_a(std::vector<Argument* > * v, Value & val)
{
  for(Value::iterator it = val.getValues().begin(); it != val.getValues().end(); it++)
    {
      const Value & v2 = *it;
      Argument* ms = (Argument*) v2.getValue();
      v->push_back(ms);		     
    }
}
}}
rules:
File	= Interface Spacing <eof> {{ value = $1; }}

Interface = INTERFACE n:Identifier OPENC Spacing m:Message+ CLOSEC SEMI {{ std::vector<Message*> * functions = new std::vector<Message*>;
		     cast_m(functions, m);
		     value = new Interface((char *)n.getValue(), functions); }}

		  | INTERFACE n:Identifier d:Description OPENC m:Message+ CLOSEC SEMI {{ std::vector<Message* > * functions = new std::vector<Message*>;
		     cast_m(functions, m);
		     value = new Interface((char *)n.getValue(),(char *)d.getValue(), functions); }}
		     

Message      =	   MESSAGE i:Identifier OPEN a:Arguments CLOSE SEMI Spacing {{
	     	   value = new Message((char*)i.getValue(), (std::vector<Argument*> *) a.getValue()); }}

Arguments    =	    a:ArgStart* a2:ArgLast {{ std::vector<Argument*> * args = new std::vector<Argument*>;
		      cast_a(args, a);
		      Argument * as = (Argument *) a2.getValue();
		      args->push_back(as);
		      value = args; }}

ArgStart     =	   s:SimpleArg COMMA Spacing {{ value = s; }}	        
		   | d:DynamicArg COMMA Spacing {{ value = d; }}

ArgLast	     =	   s:SimpleArg Spacing {{ value = s; }}
		   | d:DynamicArg Spacing {{ value = d; }}

SimpleArg    =	   t:Identifier i:Identifier {{ 
	     	   Type * ty = new Type((char *) t.getValue());
		   value = new Argument(ty, (char *) i.getValue()); }}

DynamicArg   =	   t:Identifier i:Identifier OPENS i2:Identifier CLOSES {{
	     	   Type * ty = new Type((char *) t.getValue()); 
	     	   value = new Argument(ty, (char *) i.getValue(), (char *) i2.getValue()); }}

Type	     =	   "bool" | "int32" | "char" 
	     	   

Description  =	   """ d:.* """ Spacing
	     	   

Identifier   =	   i1:IdentStart i2:IdentCont* Spacing {{
	     	   char * str = (char *) malloc(sizeof(char)*(2+ i2.getValues().size()));
		   char * temp1 = (char *) malloc(sizeof(char)*2);
		   temp1[0] = (char) (intptr_t) i1.getValue();
		   temp1[1] = '\0';
		   strcpy(str, temp1);
		   for(Value::iterator it = i2.getValues().begin(); it != i2.getValues().end(); it ++)
		   {
			const Value & v = *it;
			char letter = (char) (intptr_t) v.getValue();
			char * temp2 = (char *) malloc(sizeof(char)*2);
			temp2[0] = letter;
			temp2[1] = '\0';
			strcat(str, temp2);
		   }
		   value = str; }}
		   
		      
IdentStart   =	   [abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_]
IdentCont    =	   IdentStart
		   | [0123456789]



## reserved words
MESSAGE	     =	   "message" Spacing
INTERFACE    =	   "interface" Spacing


SEMI	     =	   ";"
OPENC	     =	   "{"
CLOSEC	     =	   "}"
OPENS	     =	   "["
CLOSES	     =	   "]"
OPEN	     =	   "("
CLOSE	     =	   ")"
COMMA	     =	   ","

Spacing	     =	   Space*
Space	     =	   " " | "\t" | EndOfLine
##Comment	     =	   "/*" .* "*/" 
##	     	   | "//" (!EndOfLine .)* EndOfLine

EndOfLine    =	  "\n" 
	     	  | "\r"
