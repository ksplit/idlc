start-symbol: File
options: debug9

include: {{ #include "ast.h"
	    #include <vector>
	    #include <stdlib.h> }}
code: {{
      void cast_m(std::vector<Message* > * v, Value & val)
{
  for(Value::iterator it = val.getValues().begin(); it != val.getValues().end(); it++)
    {
      const Value & v2 = *it;
      Message* ms = (Message*) v2.getValue();
      v->push_back(ms);		     
    }
}
void cast_a(std::vector<Argument* > * v, Value & val)
{
  for(Value::iterator it = val.getValues().begin(); it != val.getValues().end(); it++)
    {
      const Value & v2 = *it;
      Argument* ms = (Argument*) v2.getValue();
      v->push_back(ms);		     
    }
}
}}
rules:
File	= Interface Spacing <eof> {{ value = $1; }}

Interface = INTERFACE n:Identifier OPENC Spacing m:Message+ CLOSEC SEMI {{ std::vector<Message*> * functions = new std::vector<Message*>;
		     cast_m(functions, m);
		     value = new Interface((char *)n.getValue(), functions); }}

		  | INTERFACE n:Identifier d:Description OPENC m:Message+ CLOSEC SEMI {{ std::vector<Message* > * functions = new std::vector<Message*>;
		     cast_m(functions, m);
		     value = new Interface((char *)n.getValue(),(char *)d.getValue(), functions); }}
		     

Message      =	   MESSAGE i:Identifier OPEN a:Arguments CLOSE SEMI Spacing {{ std::vector<Argument*> * args = new std::vector<Argument*>;
	     	   cast_a(args, a);
	     	   value = new Message((char*)i.getValue(), args); }}

Arguments    =	    a:ArgStart* a2:ArgLast {{ std::vector<Argument*> * args = new std::vector<Argument*>;
		      cast_a(args, a);
		      Argument * as = (Argument *) a2.getValue();
		      args->push_back(as);
		      value = args; }}

ArgStart     =	   s:SimpleArg COMMA Spacing {{ value = s; }}	        
		   | d:DynamicArg COMMA Spacing {{ value = d; }}

ArgLast	     =	   s:SimpleArg Spacing {{ value = s; }}
		   | d:DynamicArg Spacing {{ value = d; }}

SimpleArg    =	   t:Identifier i:Identifier {{ value = new Argument((Type*) t.getValue(), (char *) i.getValue()); }}

DynamicArg   =	   t:Identifier i:Identifier OPENS i2:Identifier CLOSES {{ value = new Argument((Type*) t.getValue(), (char *) i.getValue(), (char *) i2.getValue()); }}

Type	     =	   "bool" | "int32" | "char" 
	     	   

Description  =	   """ d:.* """ Spacing
	     	   

Identifier   =	   i1:IdentStart i2:IdentCont* Spacing
		      
IdentStart   =	   i:[abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_] {{
		      value = i; }}
IdentCont    =	   i:IdentStart {{
		      value = i; }}
		   | i:[0123456789] {{ 
		      value = i; }}



## reserved words
MESSAGE	     =	   "message" Spacing
INTERFACE    =	   "interface" Spacing


SEMI	     =	   ";"
OPENC	     =	   "{"
CLOSEC	     =	   "}"
OPENS	     =	   "["
CLOSES	     =	   "]"
OPEN	     =	   "("
CLOSE	     =	   ")"
COMMA	     =	   ","

Spacing	     =	   Space*
Space	     =	   " " | "\t" | EndOfLine
##Comment	     =	   "/*" .* "*/" 
##	     	   | "//" (!EndOfLine .)* EndOfLine

EndOfLine    =	  "\n" 
	     	  | "\r"
